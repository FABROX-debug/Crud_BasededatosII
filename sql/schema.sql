-- ==========================================================
-- SCHEMA.SQL - SISTEMA DE GESTIÓN DE CITAS MÉDICAS
-- ==========================================================
-- Este script crea las tablas, secuencias, triggers y procedimientos
-- almacenados necesarios para el sistema.
-- ==========================================================

-- ----------------------------------------------------------
-- 1. ELIMINACIÓN DE OBJETOS PREVIOS (LIMPIEZA)
-- ----------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE CITAS CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE HORARIOS CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE MEDICOS CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE PACIENTES CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE USUARIOS CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE AUDITORIA CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

-- ----------------------------------------------------------
-- 2. CREACIÓN DE TABLAS
-- ----------------------------------------------------------

CREATE TABLE USUARIOS (
    ID_USUARIO       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DNI              VARCHAR2(8) NOT NULL,
    NOMBRE           VARCHAR2(100) NOT NULL,
    TIPO             VARCHAR2(20) CHECK (TIPO IN ('ADMIN','MEDICO','PACIENTE')),
    PASSWORD         VARCHAR2(200) NOT NULL,
    ESTADO           CHAR(1) DEFAULT 'S' CHECK (ESTADO IN ('S','N'))
);

CREATE TABLE PACIENTES (
    ID_PACIENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DNI         VARCHAR2(8) UNIQUE NOT NULL,
    NOMBRE      VARCHAR2(100) NOT NULL,
    CORREO      VARCHAR2(120),
    TELEFONO    VARCHAR2(15),
    FECHA_REG   DATE DEFAULT SYSDATE
);

CREATE TABLE MEDICOS (
    ID_MEDICO    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DNI          VARCHAR2(8) UNIQUE NOT NULL,
    NOMBRE       VARCHAR2(100) NOT NULL,
    ESPECIALIDAD VARCHAR2(60) NOT NULL,
    ESTADO       CHAR(1) DEFAULT 'S' CHECK (ESTADO IN ('S','N'))
);

CREATE TABLE HORARIOS (
    ID_HORARIO     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_MEDICO      NUMBER NOT NULL,
    FECHA          DATE NOT NULL,
    HORA_INICIO    VARCHAR2(5) NOT NULL,
    HORA_FIN       VARCHAR2(5) NOT NULL,
    DISPONIBLE     CHAR(1) DEFAULT 'S' CHECK (DISPONIBLE IN ('S','N')),
    CONSTRAINT FK_HORARIO_MEDICO FOREIGN KEY (ID_MEDICO)
        REFERENCES MEDICOS(ID_MEDICO)
);

CREATE TABLE CITAS (
    ID_CITA     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_PACIENTE NUMBER NOT NULL,
    ID_MEDICO   NUMBER NOT NULL,
    ID_HORARIO  NUMBER NOT NULL,
    MOTIVO      VARCHAR2(300),
    FECHA_REG   DATE DEFAULT SYSDATE,
    ESTADO      VARCHAR2(20) DEFAULT 'PROGRAMADA' CHECK (ESTADO IN ('PROGRAMADA','ATENDIDA','CANCELADA')),
    CONSTRAINT FK_CITA_PAC FOREIGN KEY (ID_PACIENTE)
        REFERENCES PACIENTES(ID_PACIENTE),
    CONSTRAINT FK_CITA_MED FOREIGN KEY (ID_MEDICO)
        REFERENCES MEDICOS(ID_MEDICO),
    CONSTRAINT FK_CITA_HOR FOREIGN KEY (ID_HORARIO)
        REFERENCES HORARIOS(ID_HORARIO)
);

CREATE TABLE AUDITORIA (
    ID_AUDITORIA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TABLA        VARCHAR2(30),
    OPERACION    VARCHAR2(10),
    USUARIOBD    VARCHAR2(30),
    DATOS_OLD    VARCHAR2(4000),
    DATOS_NEW    VARCHAR2(4000),
    FECHA_HORA   DATE DEFAULT SYSDATE
);

-- ----------------------------------------------------------
-- 3. TRIGGERS (5 TRIGGERS SOLICITADOS)
-- ----------------------------------------------------------

-- TRIGGER 1: Auditoría de USUARIOS
CREATE OR REPLACE TRIGGER TRG_AUDIT_USUARIOS
AFTER INSERT OR UPDATE OR DELETE ON USUARIOS
FOR EACH ROW
DECLARE
    v_operacion VARCHAR2(10);
BEGIN
    IF INSERTING THEN v_operacion := 'INSERT';
    ELSIF UPDATING THEN v_operacion := 'UPDATE';
    ELSE v_operacion := 'DELETE';
    END IF;
    
    INSERT INTO AUDITORIA (TABLA, OPERACION, USUARIOBD, DATOS_OLD, DATOS_NEW)
    VALUES ('USUARIOS', v_operacion, USER, 
            'ID:' || :OLD.ID_USUARIO || ' DNI:' || :OLD.DNI, 
            'ID:' || :NEW.ID_USUARIO || ' DNI:' || :NEW.DNI);
END;
/

-- TRIGGER 2: Auditoría de CITAS
CREATE OR REPLACE TRIGGER TRG_AUDIT_CITAS
AFTER INSERT OR UPDATE OR DELETE ON CITAS
FOR EACH ROW
DECLARE
    v_operacion VARCHAR2(10);
BEGIN
    IF INSERTING THEN v_operacion := 'INSERT';
    ELSIF UPDATING THEN v_operacion := 'UPDATE';
    ELSE v_operacion := 'DELETE';
    END IF;

    INSERT INTO AUDITORIA (TABLA, OPERACION, USUARIOBD, DATOS_OLD, DATOS_NEW)
    VALUES ('CITAS', v_operacion, USER, 
            'ID:' || :OLD.ID_CITA || ' ESTADO:' || :OLD.ESTADO, 
            'ID:' || :NEW.ID_CITA || ' ESTADO:' || :NEW.ESTADO);
END;
/

-- TRIGGER 3: Actualizar Disponibilidad de Horario al Crear Cita
CREATE OR REPLACE TRIGGER TRG_ACTUALIZAR_HORARIO_CITA
AFTER INSERT ON CITAS
FOR EACH ROW
BEGIN
    UPDATE HORARIOS
    SET DISPONIBLE = 'N'
    WHERE ID_HORARIO = :NEW.ID_HORARIO;
END;
/

-- TRIGGER 4: Liberar Horario al Cancelar Cita
CREATE OR REPLACE TRIGGER TRG_LIBERAR_HORARIO_CANCEL
AFTER UPDATE OF ESTADO ON CITAS
FOR EACH ROW
BEGIN
    IF :NEW.ESTADO = 'CANCELADA' AND :OLD.ESTADO <> 'CANCELADA' THEN
        UPDATE HORARIOS
        SET DISPONIBLE = 'S'
        WHERE ID_HORARIO = :NEW.ID_HORARIO;
    END IF;
END;
/

-- TRIGGER 5: Validar Fecha de Horario (No permitir fechas pasadas al insertar)
CREATE OR REPLACE TRIGGER TRG_VALIDAR_FECHA_HORARIO
BEFORE INSERT ON HORARIOS
FOR EACH ROW
BEGIN
    IF :NEW.FECHA < TRUNC(SYSDATE) THEN
        RAISE_APPLICATION_ERROR(-20001, 'No se pueden registrar horarios en fechas pasadas.');
    END IF;
END;
/

-- ----------------------------------------------------------
-- 4. REPORTES PL/SQL (10 PROCEDIMIENTOS ALMACENADOS)
-- ----------------------------------------------------------

-- REPORTE 1: Listar todas las citas de un médico específico
CREATE OR REPLACE PROCEDURE SP_REPORTE_CITAS_MEDICO (
    p_id_medico IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT c.ID_CITA, p.NOMBRE AS PACIENTE, c.FECHA_REG, h.FECHA, h.HORA_INICIO, c.ESTADO
        FROM CITAS c
        JOIN PACIENTES p ON c.ID_PACIENTE = p.ID_PACIENTE
        JOIN HORARIOS h ON c.ID_HORARIO = h.ID_HORARIO
        WHERE c.ID_MEDICO = p_id_medico
        ORDER BY h.FECHA DESC, h.HORA_INICIO ASC;
END;
/

-- REPORTE 2: Listar historial de citas de un paciente
CREATE OR REPLACE PROCEDURE SP_REPORTE_HISTORIAL_PACIENTE (
    p_id_paciente IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT c.ID_CITA, m.NOMBRE AS MEDICO, m.ESPECIALIDAD, h.FECHA, c.ESTADO
        FROM CITAS c
        JOIN MEDICOS m ON c.ID_MEDICO = m.ID_MEDICO
        JOIN HORARIOS h ON c.ID_HORARIO = h.ID_HORARIO
        WHERE c.ID_PACIENTE = p_id_paciente
        ORDER BY h.FECHA DESC;
END;
/

-- REPORTE 3: Listar médicos por especialidad
CREATE OR REPLACE PROCEDURE SP_REPORTE_MEDICOS_ESPECIALIDAD (
    p_especialidad IN VARCHAR2,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT ID_MEDICO, NOMBRE, DNI, ESTADO
        FROM MEDICOS
        WHERE UPPER(ESPECIALIDAD) LIKE '%' || UPPER(p_especialidad) || '%'
        ORDER BY NOMBRE;
END;
/

-- REPORTE 4: Top 5 Médicos con más citas atendidas
CREATE OR REPLACE PROCEDURE SP_REPORTE_TOP_MEDICOS (
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT m.NOMBRE, COUNT(c.ID_CITA) AS TOTAL_CITAS
        FROM MEDICOS m
        JOIN CITAS c ON m.ID_MEDICO = c.ID_MEDICO
        WHERE c.ESTADO = 'ATENDIDA'
        GROUP BY m.NOMBRE
        ORDER BY TOTAL_CITAS DESC
        FETCH FIRST 5 ROWS ONLY;
END;
/

-- REPORTE 5: Citas programadas para un rango de fechas
CREATE OR REPLACE PROCEDURE SP_REPORTE_CITAS_RANGO (
    p_fecha_inicio IN DATE,
    p_fecha_fin IN DATE,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT c.ID_CITA, p.NOMBRE AS PACIENTE, m.NOMBRE AS MEDICO, h.FECHA, h.HORA_INICIO
        FROM CITAS c
        JOIN PACIENTES p ON c.ID_PACIENTE = p.ID_PACIENTE
        JOIN MEDICOS m ON c.ID_MEDICO = m.ID_MEDICO
        JOIN HORARIOS h ON c.ID_HORARIO = h.ID_HORARIO
        WHERE h.FECHA BETWEEN p_fecha_inicio AND p_fecha_fin
        ORDER BY h.FECHA;
END;
/

-- REPORTE 6: Horarios disponibles por médico
CREATE OR REPLACE PROCEDURE SP_REPORTE_HORARIOS_DISPONIBLES (
    p_id_medico IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT ID_HORARIO, FECHA, HORA_INICIO, HORA_FIN
        FROM HORARIOS
        WHERE ID_MEDICO = p_id_medico
          AND DISPONIBLE = 'S'
          AND FECHA >= TRUNC(SYSDATE)
        ORDER BY FECHA, HORA_INICIO;
END;
/

-- REPORTE 7: Resumen de citas por estado (Estadística)
CREATE OR REPLACE PROCEDURE SP_REPORTE_ESTADISTICA_ESTADOS (
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT ESTADO, COUNT(*) AS CANTIDAD
        FROM CITAS
        GROUP BY ESTADO;
END;
/

-- REPORTE 8: Pacientes sin citas en los últimos 6 meses (Inactivos)
CREATE OR REPLACE PROCEDURE SP_REPORTE_PACIENTES_INACTIVOS (
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT p.ID_PACIENTE, p.NOMBRE, p.CORREO, MAX(h.FECHA) AS ULTIMA_CITA
        FROM PACIENTES p
        LEFT JOIN CITAS c ON p.ID_PACIENTE = c.ID_PACIENTE
        LEFT JOIN HORARIOS h ON c.ID_HORARIO = h.ID_HORARIO
        GROUP BY p.ID_PACIENTE, p.NOMBRE, p.CORREO
        HAVING MAX(h.FECHA) < ADD_MONTHS(SYSDATE, -6) OR MAX(h.FECHA) IS NULL;
END;
/

-- REPORTE 9: Auditoría de operaciones recientes
CREATE OR REPLACE PROCEDURE SP_REPORTE_AUDITORIA (
    p_limite IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT ID_AUDITORIA, TABLA, OPERACION, USUARIOBD, FECHA_HORA, DATOS_OLD, DATOS_NEW
        FROM AUDITORIA
        ORDER BY FECHA_HORA DESC
        FETCH FIRST p_limite ROWS ONLY;
END;
/

-- REPORTE 10: Total de ingresos estimados (Simulado por citas atendidas)
-- Asumiendo un costo fijo por cita para el ejemplo, o simplemente conteo
CREATE OR REPLACE PROCEDURE SP_REPORTE_INGRESOS_MES (
    p_mes IN NUMBER,
    p_anio IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
        SELECT m.ESPECIALIDAD, COUNT(c.ID_CITA) AS CITAS_ATENDIDAS, 
               COUNT(c.ID_CITA) * 50 AS INGRESO_ESTIMADO -- $50 por cita ejemplo
        FROM CITAS c
        JOIN HORARIOS h ON c.ID_HORARIO = h.ID_HORARIO
        JOIN MEDICOS m ON c.ID_MEDICO = m.ID_MEDICO
        WHERE EXTRACT(MONTH FROM h.FECHA) = p_mes
          AND EXTRACT(YEAR FROM h.FECHA) = p_anio
          AND c.ESTADO = 'ATENDIDA'
        GROUP BY m.ESPECIALIDAD;
END;
/

-- ----------------------------------------------------------
-- 5. DATOS INICIALES (SEMILLA)
-- ----------------------------------------------------------
INSERT INTO USUARIOS (DNI, NOMBRE, TIPO, PASSWORD, ESTADO)
VALUES ('ADMIN', 'ADMINISTRADOR PRINCIPAL', 'ADMIN', 'admin123', 'S');

COMMIT;
